<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Painel MASTER â€” Frutiger Aero LÃ­der</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="database.js"></script>
  <script type="module">
    import { requireAuth } from "./auth.js";
    window.requireAuth = requireAuth;
  </script>
</head>
<body>
  <div class="bg-sky"></div>
  <div class="adm-layout">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
      <div class="orb orb-md orb-gold lider-destaque">ğŸ‘‘</div>
      <div><h1 style="font-size:20px;font-weight:900;">Painel de Controle MASTER</h1>
        <p style="font-size:12px;color:var(--text-light);">Gerenciamento Total: UsuÃ¡rios, XP e Conquistas</p>
      </div>
    </div>

    <div class="adm-tabs">
      <button class="admtab active" onclick="switchTab('usuarios',this)">ğŸ‘¥ UsuÃ¡rios</button>
      <button class="admtab" onclick="switchTab('conquistas',this)">ğŸ… Conquistas</button>
      <button class="admtab" onclick="switchTab('desafios',this)">âš¡ Desafios</button>
    </div>

    <!-- GESTÃƒO DE USUÃRIOS -->
    <div class="adm-section active glass" id="adm-usuarios" style="padding:20px;">
      <p class="section-title">AprovaÃ§Ãµes Pendentes & GestÃ£o</p>
      <div id="users-list"></div>
    </div>

    <!-- GESTÃƒO DE CONQUISTAS -->
    <div class="adm-section" id="adm-conquistas">
      <div class="glass adm-form" style="padding:20px;margin-bottom:14px;">
        <p class="section-title">ğŸ… Criar Nova Conquista (Badge)</p>
        <div class="form-grid">
          <input type="text" id="badge-nome" class="aero-input" placeholder="Nome da Conquista">
          <select id="badge-categoria" class="aero-select">
            <option value="comum">ğŸ”µ Comum (Aero/Vidro)</option>
            <option value="rara">ğŸŸ£ Rara (Roxo Neon)</option>
            <option value="lendaria">ğŸ† LendÃ¡ria (Dourado Brilhante)</option>
          </select>
          <input type="text" id="badge-icone" class="aero-input" placeholder="Emoji (ex: ğŸ†)">
          <textarea id="badge-desc" class="aero-textarea full-width" placeholder="DescriÃ§Ã£o da conquista..."></textarea>
        </div>
        <button class="btn btn-green mt-16" onclick="saveBadge()">Salvar Conquista</button>
      </div>
      <div id="badges-list" class="glass" style="padding:20px;"></div>
    </div>

    <!-- GESTÃƒO DE DESAFIOS -->
    <div class="adm-section" id="adm-desafios">
       <div class="glass adm-form" style="padding:20px;">
        <p class="section-title">âš¡ LanÃ§ar Desafio RelÃ¢mpago</p>
        <input type="text" id="d-titulo" class="aero-input mb-10" placeholder="TÃ­tulo do Desafio">
        <textarea id="d-desc" class="aero-textarea mb-10" placeholder="DescriÃ§Ã£o e regras..."></textarea>
        <input type="number" id="d-xp" class="aero-input" placeholder="XP Recompensa">
        <button class="btn btn-blue mt-16" onclick="createDesafio()">LanÃ§ar no Feed</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;

    window.requireAuth(userData => {
      if (userData.role !== 'MASTER' && userData.role !== 'admin') {
        window.location.href = 'index.html';
        return;
      }
      currentUser = userData;
      loadUsers();
      loadBadges();
    });

    function switchTab(name, btn) {
      document.querySelectorAll('.adm-section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.admtab').forEach(el => el.classList.remove('active'));
      document.getElementById(`adm-${name}`).classList.add('active');
      btn.classList.add('active');
    }

    async function loadUsers() {
      db.collection('usuarios').orderBy('createdAt', 'desc').onSnapshot(snap => {
        const el = document.getElementById('users-list');
        el.innerHTML = '';
        snap.forEach(doc => {
          const u = doc.data();
          const uid = doc.id;
          el.innerHTML += `
            <div class="user-row glass-sm" style="padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px;">
              ${renderAvatar(u, 'sm')}
              <div style="flex:1">
                <strong>${u.nome}</strong> (${u.role})<br>
                <small>${u.email} Â· ${u.xp || 0} XP Â· ${u.aprovado ? 'âœ… Aprovado' : 'â³ PENDENTE'}</small>
              </div>
              <div>
                ${!u.aprovado ? `<button class="btn btn-green btn-sm" onclick="approveUser('${uid}')">Aprovar</button>` : ''}
                <button class="btn btn-blue btn-sm" onclick="grantBadgePrompt('${uid}')">Badge</button>
                <button class="btn btn-gold btn-sm" onclick="setLeader('${uid}', '${u.tipo}')">ğŸ‘‘ LÃ­der</button>
              </div>
            </div>`;
        });
      });
    }

    async function approveUser(uid) {
      await db.collection('usuarios').doc(uid).update({ aprovado: true });
      alert("UsuÃ¡rio aprovado com sucesso!");
    }

    async function setLeader(uid, tipo) {
      const field = tipo === 'INTERNO' ? 'liderInterno' : 'liderCorretor';
      // Limpa lÃ­der anterior
      const snap = await db.collection('usuarios').where(field, '==', true).get();
      const batch = db.batch();
      snap.forEach(d => batch.update(d.ref, { [field]: false }));
      // Seta novo
      batch.update(db.collection('usuarios').doc(uid), { [field]: true });
      await batch.commit();
      alert("LÃ­der do MÃªs atualizado!");
    }

    async function saveBadge() {
      const nome = document.getElementById('badge-nome').value;
      const cat = document.getElementById('badge-categoria').value;
      const icone = document.getElementById('badge-icone').value;
      const desc = document.getElementById('badge-desc').value;
      
      await db.collection('conquistas').add({ nome, categoria: cat, icone, descricao: desc });
      alert("Conquista criada!");
    }

    async function loadBadges() {
      db.collection('conquistas').onSnapshot(snap => {
        const el = document.getElementById('badges-list');
        el.innerHTML = '<p class="section-title">Conquistas Cadastradas</p>';
        snap.forEach(doc => {
          const b = doc.data();
          el.innerHTML += `<div class="badge-${b.categoria}" style="padding:5px 12px;border-radius:20px;display:inline-block;margin:5px;font-size:12px;">${b.icone} ${b.nome}</div>`;
        });
      });
    }

    async function grantBadgePrompt(uid) {
      const snap = await db.collection('conquistas').get();
      let list = "Escolha o ID da conquista:\n";
      const badges = [];
      snap.forEach(d => {
        badges.push({id: d.id, ...d.data()});
        list += `${badges.length - 1}: ${d.data().nome}\n`;
      });
      const idx = prompt(list);
      if (idx !== null && badges[idx]) {
        await db.collection('usuarios').doc(uid).update({
          conquistas: firebase.firestore.FieldValue.arrayUnion(badges[idx])
        });
        alert("Conquista concedida!");
      }
    }
  </script>
</body>
</html>
