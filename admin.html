<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Painel MASTER â€” Frutiger Aero LÃ­der</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="database.js"></script>
  <script type="module">
    import { requireAuth } from "./auth.js";
    window.requireAuth = requireAuth;
  </script>
  <style>
    .adm-layout{position:relative;z-index:10;max-width:1100px;margin:0 auto;padding:14px 12px 90px;}
    .adm-tabs{display:flex;gap:10px;margin-bottom:20px;justify-content:center;}
    .admtab{padding:12px 24px;border-radius:50px;font-family:var(--font);font-size:14px;font-weight:800;cursor:pointer;border:none;background:rgba(255,255,255,.38);color:var(--text-light);transition:var(--trans);box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    .admtab.active{background:linear-gradient(180deg,#55b8ff,#0088ee);color:#fff;box-shadow:0 4px 15px rgba(0,100,255,.35);}
    .adm-section{display:none;} .adm-section.active{display:block;}
    .user-row{display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:16px;background:rgba(255,255,255,.5);border:1.5px solid rgba(255,255,255,.8);margin-bottom:10px;transition:var(--trans);}
    .user-row:hover{background:rgba(255,255,255,.75);transform:translateY(-2px);}
    .adm-form{padding:24px;margin-bottom:20px;display:flex;flex-direction:column;gap:15px;}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
    .full-width{grid-column:1/-1;}
  </style>
</head>
<body>
  <div class="bg-sky"></div>
  <div class="aurora aurora-1"></div><div class="aurora aurora-2"></div><div class="aurora aurora-3"></div>

  <header id="global-header" class="glass" style="margin: 14px 12px; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 100;">
    <div style="display: flex; align-items: center; gap: 12px;">
      <div class="orb" style="width: 40px; height: 40px; background: var(--orb-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">ğŸ‘‘</div>
      <h1 style="font-size: 18px; font-weight: 900; color: var(--text);">PAINEL DE CONTROLE MASTER</h1>
    </div>
    <button class="btn btn-blue" onclick="location.href='index.html'">Voltar ao Hub</button>
  </header>

  <div class="adm-layout">
    
    <div class="adm-tabs">
      <button class="admtab active" onclick="switchAdmTab('usuarios',this)">ğŸ‘¥ UsuÃ¡rios</button>
      <button class="admtab" onclick="switchAdmTab('conquistas',this)">ğŸ… Conquistas</button>
      <button class="admtab" onclick="switchAdmTab('desafios',this)">âš¡ Desafios</button>
      <button class="admtab" onclick="switchAdmTab('metas',this)">ğŸ¯ Metas</button>
    </div>

    <!-- USUÃRIOS -->
    <div class="adm-section active glass" id="adm-usuarios" style="padding:24px;">
      <p class="section-title">Gerenciar Equipe & AprovaÃ§Ãµes</p>
      <div style="margin-bottom: 15px;">
        <button class="btn btn-red btn-sm" onclick="resetAllXP()">âš ï¸ Resetar Todos os XP (Manual)</button>
      </div>
      <div id="users-list"></div>
    </div>

    <!-- CONQUISTAS -->
    <div class="adm-section" id="adm-conquistas">
      <div class="glass adm-form">
        <p class="section-title">ğŸ… Criar Nova Conquista (Badge)</p>
        <div class="form-grid">
          <input type="text" id="badge-nome" class="aero-input" placeholder="Nome da Conquista (ex: Sniper do PME)">
          <select id="badge-categoria" class="aero-select">
            <option value="comum">ğŸ”µ Comum (Aero/Vidro)</option>
            <option value="rara">ğŸŸ£ Rara (Roxo Neon)</option>
            <option value="lendaria">ğŸ† LendÃ¡ria (Dourado Brilhante)</option>
          </select>
          <input type="text" id="badge-icone" class="aero-input" placeholder="Emoji (ex: ğŸ¯)">
          <input type="number" id="badge-xp" class="aero-input" placeholder="XP BÃ´nus (opcional)">
          <textarea id="badge-desc" class="aero-textarea full-width" placeholder="DescriÃ§Ã£o da conquista..."></textarea>
        </div>
        <button class="btn btn-green" onclick="saveBadge()">+ Criar e Salvar Conquista</button>
        <button class="btn btn-blue mt-10" onclick="seedDefaultBadges()" style="margin-top:10px;">âœ¨ Gerar Conquistas PadrÃ£o</button>
      </div>
      <div class="glass" style="padding:24px;">
        <p class="section-title">Lista de Conquistas</p>
        <div id="badges-list" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
      </div>
    </div>

    <!-- DESAFIOS -->
    <div class="adm-section" id="adm-desafios">
      <div class="glass adm-form">
        <p class="section-title">âš¡ LanÃ§ar Desafio RelÃ¢mpago</p>
        <input type="text" id="d-titulo" class="aero-input" placeholder="TÃ­tulo do Desafio">
        <textarea id="d-desc" class="aero-textarea" placeholder="DescriÃ§Ã£o e regras para o Feed..."></textarea>
        <input type="number" id="d-xp" class="aero-input" placeholder="XP Recompensa">
        <button class="btn btn-blue" onclick="createDesafio()">LanÃ§ar Desafio no Feed</button>
      </div>
    </div>

    <!-- METAS -->
    <div class="adm-section" id="adm-metas">
      <div class="glass adm-form">
        <p class="section-title">ğŸ¯ Definir Meta Pessoal</p>
        <div class="form-grid">
          <select id="m-usuario" class="aero-select"></select>
          <input type="text" id="m-titulo" class="aero-input" placeholder="TÃ­tulo da Meta">
          <input type="number" id="m-obj" class="aero-input" placeholder="Objetivo (nÃºmero)">
          <input type="number" id="m-xp" class="aero-input" placeholder="XP se completar">
        </div>
        <button class="btn btn-gold" onclick="createMeta()">ğŸ¯ Atribuir Meta</button>
      </div>
    </div>

  </div>

  <script>
    let currentUser = null;

    window.requireAuth(userData => {
      if (userData.role !== 'MASTER' && userData.role !== 'admin') {
        window.location.href = 'index.html';
        return;
      }
      currentUser = userData;
      loadUsers();
      loadBadges();
      loadUsersForSelect();
    });

    function switchAdmTab(name, btn) {
      document.querySelectorAll('.adm-section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.admtab').forEach(el => el.classList.remove('active'));
      document.getElementById(`adm-${name}`).classList.add('active');
      btn.classList.add('active');
    }

    async function loadUsers() {
      db.collection('usuarios').orderBy('createdAt', 'desc').onSnapshot(snap => {
        const el = document.getElementById('users-list');
        el.innerHTML = '';
        snap.forEach(doc => {
          const u = doc.data();
          const uid = doc.id;
          const statusSi = u.status==='online'?{cls:'status-online',lbl:'Online'}:u.status==='intervalo'?{cls:'status-intervalo',lbl:'Intervalo'}:{cls:'status-offline',lbl:'Offline'};
          
          el.innerHTML += `
            <div class="user-row">
              ${renderAvatar(u, 'sm')}
              <div style="flex:1">
                <strong style="font-size:14px;">${u.nome}</strong> 
                <span class="badge-comum" style="font-size:10px; padding:2px 8px;">${u.role}</span>
                <br><small style="color:var(--text-light);">${u.email} Â· ${u.xp || 0} XP Â· ${u.aprovado ? 'âœ… Aprovado' : 'â³ PENDENTE'}</small>
              </div>
              <div style="display:flex; gap:6px;">
                ${!u.aprovado ? `<button class="btn btn-green btn-sm" style="padding:6px 12px; font-size:11px;" onclick="approveUser('${uid}')">Aprovar</button>` : ''}
                <button class="btn btn-blue btn-sm" style="padding:6px 12px; font-size:11px;" onclick="grantBadgePrompt('${uid}')">Badge</button>
                <button class="btn btn-gold btn-sm" style="padding:6px 12px; font-size:11px;" onclick="setLeader('${uid}', '${u.tipo}')">ğŸ‘‘ LÃ­der</button>
                ${u.role === 'USER' ? `<button class="btn btn-pink btn-sm" style="padding:6px 12px; font-size:11px;" onclick="promoteAdmin('${uid}')">Admin</button>` : ''}
              </div>
            </div>`;
        });
      });
    }

    async function approveUser(uid) {
      await db.collection('usuarios').doc(uid).update({ aprovado: true });
      alert("UsuÃ¡rio aprovado!");
    }

    async function promoteAdmin(uid) {
      if(confirm("Promover este usuÃ¡rio a Admin?")) {
        await db.collection('usuarios').doc(uid).update({ role: 'admin' });
        alert("UsuÃ¡rio promovido!");
      }
    }

    async function resetAllXP() {
      if(!confirm("TEM CERTEZA? Isso resetarÃ¡ o XP de TODOS os usuÃ¡rios para 0!")) return;
      const snap = await db.collection('usuarios').get();
      const batch = db.batch();
      const now = new Date();
      const monthStr = `${now.getFullYear()}-${now.getMonth() + 1}`;
      
      snap.forEach(d => {
        batch.update(d.ref, { xp: 0, lastResetMonth: monthStr });
      });
      await batch.commit();
      alert("Todos os XP foram resetados!");
    }

    async function setLeader(uid, tipo) {
      const field = tipo === 'INTERNO' ? 'liderInterno' : 'liderCorretor';
      const snap = await db.collection('usuarios').where(field, '==', true).get();
      const batch = db.batch();
      snap.forEach(d => batch.update(d.ref, { [field]: false }));
      batch.update(db.collection('usuarios').doc(uid), { [field]: true });
      await batch.commit();
      alert("LÃ­der do MÃªs atualizado!");
    }

    async function saveBadge() {
      const nome = document.getElementById('badge-nome').value;
      const cat = document.getElementById('badge-categoria').value;
      const icone = document.getElementById('badge-icone').value;
      const desc = document.getElementById('badge-desc').value;
      const xp = parseInt(document.getElementById('badge-xp').value) || 0;
      
      if(!nome || !icone) return alert("Preencha nome e Ã­cone!");
      await db.collection('conquistas').add({ nome, categoria: cat, icone, descricao: desc, xpBonus: xp });
      alert("Conquista criada!");
    }

    async function seedDefaultBadges() {
      const defaultBadges = [
        { nome: "LÃ­der de LÃ­deres", categoria: "lendaria", icone: "ğŸ†", descricao: "Mais de 3 anos de casa. O veterano supremo." },
        { nome: "Estrategista Hapvida", categoria: "lendaria", icone: "ğŸ¯", descricao: "Para quem desenha as melhores estratÃ©gias de vendas." },
        { nome: "Futuro Presidente", categoria: "lendaria", icone: "ğŸ‘‘", descricao: "A cadeira da presidÃªncia te espera." },
        { nome: "Agilidade em Pessoa", categoria: "rara", icone: "âš¡", descricao: "O ADM mais rÃ¡pido no gatilho do sistema." },
        { nome: "Sniper do PME", categoria: "rara", icone: "ğŸ¯", descricao: "NÃ£o perde um contrato de Pequenas e MÃ©dias Empresas." },
        { nome: "Mestre do Fechamento", categoria: "rara", icone: "ğŸ¤", descricao: "Conssegue o 'sim' do cliente atÃ© nas situaÃ§Ãµes impossÃ­veis." },
        { nome: "Anjo da Guarda", categoria: "rara", icone: "ğŸ˜‡", descricao: "Sempre para o que estÃ¡ fazendo para ajudar um colega." },
        { nome: "Festa da Firma", categoria: "comum", icone: "ğŸ¥³", descricao: "O primeiro a confirmar presenÃ§a em qualquer evento social." },
        { nome: "Cafeineiro Oficial", categoria: "comum", icone: "â˜•", descricao: "Move-se a base de cafÃ©. A xÃ­cara Ã© parte do corpo." },
        { nome: "Dono do Feed", categoria: "comum", icone: "ğŸ“±", descricao: "O rei da interatividade, posta e comenta em tudo." },
        { nome: "Madrugador Supimpa", categoria: "comum", icone: "ğŸŒ…", descricao: "O primeiro a dar 'Bom dia' no sistema todos os dias." },
        { nome: "Inimigo da PendÃªncia", categoria: "comum", icone: "ğŸ›¡ï¸", descricao: "NÃ£o dorme enquanto tiver um processo parado." },
        { nome: "DJ do Setor", categoria: "comum", icone: "ğŸµ", descricao: "ResponsÃ¡vel pela energia e animaÃ§Ã£o do ambiente." },
        { nome: "Rindo do Perigo", categoria: "comum", icone: "ğŸ˜‚", descricao: "MantÃ©m o bom humor mesmo no fechamento sob pressÃ£o." }
      ];
      
      if(!confirm("Deseja gerar as 14 conquistas padrÃ£o?")) return;
      const batch = db.batch();
      defaultBadges.forEach(b => {
        const ref = db.collection('conquistas').doc();
        batch.set(ref, b);
      });
      await batch.commit();
      alert("Conquistas padrÃ£o geradas com sucesso!");
    }

    async function loadBadges() {
      db.collection('conquistas').onSnapshot(snap => {
        const el = document.getElementById('badges-list');
        el.innerHTML = '';
        snap.forEach(doc => {
          const b = doc.data();
          el.innerHTML += `<div class="badge-${b.categoria}">${b.icone} ${b.nome}</div>`;
        });
      });
    }

    async function grantBadgePrompt(uid) {
      const snap = await db.collection('conquistas').get();
      if(snap.empty) return alert("Nenhuma conquista criada ainda.");
      let list = "Escolha o nÃºmero da conquista:\n";
      const badges = [];
      snap.forEach(d => {
        badges.push({id: d.id, ...d.data()});
        list += `${badges.length - 1}: ${d.data().nome}\n`;
      });
      const idx = prompt(list);
      if (idx !== null && badges[idx]) {
        await db.collection('usuarios').doc(uid).update({
          conquistas: firebase.firestore.FieldValue.arrayUnion(badges[idx])
        });
        alert("Conquista concedida!");
      }
    }

    async function loadUsersForSelect() {
      const snap = await db.collection('usuarios').where('aprovado','==',true).get();
      const sel = document.getElementById('m-usuario');
      sel.innerHTML = '<option value="">Selecione o usuÃ¡rio</option>';
      snap.forEach(d => {
        sel.innerHTML += `<option value="${d.id}">${d.data().nome}</option>`;
      });
    }
  </script>
</body>
</html>
