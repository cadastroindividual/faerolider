<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Feed Social ‚Äî Frutiger Aero L√≠der</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

<script src="database.js"></script>
<script src="auth.js"></script>
  <style>
    .feed-layout{position:relative;z-index:10;max-width:720px;margin:0 auto;padding:14px 12px 90px;display:flex;flex-direction:column;gap:14px;}
    /* Composer */
    .composer{padding:20px;}
    .composer-top{display:flex;gap:12px;align-items:flex-start;}
    .composer-input-wrap{flex:1;position:relative;}
    .composer-textarea{width:100%;min-height:80px;padding:12px 16px;border-radius:16px;resize:none;font-family:var(--font);font-size:14px;color:var(--text);background:rgba(255,255,255,.72);border:1.5px solid rgba(255,255,255,.9);border-bottom-color:rgba(180,210,255,.6);outline:none;box-shadow:0 2px 8px rgba(0,80,200,.09);transition:var(--trans);}
    .composer-textarea:focus{border-color:rgba(100,180,255,.9);box-shadow:0 0 0 3px rgba(0,150,255,.18);}
    .composer-actions{display:flex;align-items:center;gap:8px;margin-top:10px;flex-wrap:wrap;}
    .img-preview{position:relative;display:inline-block;}
    .img-preview img{max-height:120px;border-radius:10px;border:2px solid rgba(255,255,255,.8);}
    .img-preview-remove{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#ff3311;border:none;color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

    /* Post card */
    .post-card{padding:0;}
    .post-header{display:flex;align-items:center;gap:12px;padding:16px 18px 10px;}
    .post-body{padding:0 18px 12px;}
    .post-text{font-size:14px;line-height:1.6;color:var(--text);word-break:break-word;}
    .post-text .hashtag{color:#0088ff;font-weight:700;cursor:pointer;}
    .post-text .mention{color:#0066cc;font-weight:800;background:rgba(0,100,255,.08);padding:1px 5px;border-radius:6px;cursor:pointer;text-decoration:none;}
    .post-img{width:100%;max-height:420px;object-fit:cover;border-radius:0;}
    .post-footer{padding:10px 14px;border-top:1px solid rgba(255,255,255,.5);display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .reaction-bar{display:flex;align-items:center;gap:4px;flex:1;flex-wrap:wrap;}
    .reaction-btn{
      padding:5px 12px;border-radius:50px;border:1px solid rgba(255,255,255,.75);
      background:rgba(255,255,255,.4);font-size:13px;font-weight:700;
      cursor:pointer;transition:var(--trans);display:flex;align-items:center;gap:4px;
      font-family:var(--font);color:var(--text);
    }
    .reaction-btn:hover{background:rgba(255,255,255,.65);transform:scale(1.06);}
    .reaction-btn.active{background:rgba(255,80,120,.15);border-color:rgba(255,80,120,.4);color:#cc0044;}
    .reaction-picker{
      position:absolute;bottom:110%;left:0;
      background:rgba(255,255,255,.92);backdrop-filter:blur(12px);
      border:1.5px solid rgba(255,255,255,.9);border-radius:14px;
      padding:8px 12px;display:flex;gap:6px;
      box-shadow:0 8px 28px rgba(0,80,200,.2);
      animation:fadeIn .15s ease;z-index:100;
    }
    .reaction-emoji{font-size:20px;cursor:pointer;transition:var(--trans);padding:2px;}
    .reaction-emoji:hover{transform:scale(1.3);}

    /* Comments */
    .comments-section{padding:0 14px 14px;display:flex;flex-direction:column;gap:8px;}
    .comment-item{display:flex;gap:8px;}
    .comment-bubble{background:rgba(255,255,255,.55);border:1px solid rgba(255,255,255,.8);border-radius:12px;padding:8px 12px;flex:1;}
    .comment-bubble strong{font-size:12px;font-weight:800;color:var(--text-mid);}
    .comment-bubble p{font-size:13px;color:var(--text);margin-top:2px;}
    .comment-input-row{display:flex;gap:8px;align-items:center;padding:0 14px 14px;}

    /* Mention dropdown positioning */
    .composer-input-wrap{position:relative;}
  </style>
</head>
<body>
  <div class="bg-sky"></div>
  <div class="aurora aurora-1"></div><div class="aurora aurora-2"></div><div class="aurora aurora-3"></div>
  <div class="bg-bokeh"><div class="bokeh b1"></div><div class="bokeh b2"></div><div class="bokeh b3"></div><div class="bokeh b4"></div><div class="bokeh b5"></div><div class="bokeh b6"></div></div>
  <header id="global-header" class="glass" style="margin: 14px 12px; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 100;">
    <div style="display: flex; align-items: center; gap: 12px;">
      <div class="orb" style="width: 40px; height: 40px; background: var(--orb-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" onclick="location.href='index.html'">ü´ß</div>
      <h1 style="font-size: 18px; font-weight: 900; color: var(--text);">FEED SOCIAL</h1>
    </div>
    <div style="display:flex;align-items:center;gap:15px;">
      <div id="master-gear" class="hidden">
        <button class="orb" style="width:36px;height:36px;background:var(--orb-pink);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 10px rgba(0,0,0,0.1);" onclick="location.href='admin.html'">‚öôÔ∏è</button>
      </div>
      <div id="user-header" style="display:flex;align-items:center;gap:12px;"></div>
    </div>
  </header>

  <div class="feed-layout">
    <!-- Composer -->
    <div class="glass composer" id="composer-box">
      <p class="section-title">üì∞ Publicar no Feed</p>
      <div class="composer-top">
        <div id="composer-avatar"></div>
        <div class="composer-input-wrap">
          <textarea id="post-text" class="composer-textarea" placeholder="O que voc√™ est√° pensando? Use @ para mencionar algu√©m e # para hashtags..." oninput="handleTextInput(this)"></textarea>
          <div class="mention-dropdown hidden" id="mention-dd"></div>
        </div>
      </div>
      <div id="img-preview-wrap"></div>
      <div class="composer-actions">
        <label class="btn btn-blue btn-sm" style="cursor:pointer;">
          üì∑ Foto <input type="file" accept="image/*" id="img-input" style="display:none;" onchange="handleImgSelect(this)">
        </label>
        <button class="btn btn-green btn-sm" onclick="publishPost()">Publicar ‚Üí</button>
        <span style="font-size:11px;color:var(--text-light);margin-left:auto;" id="char-count">0 / 1000</span>
      </div>
    </div>

    <!-- Posts -->
    <div id="posts-container"></div>
  </div>

  <div id="taskbar" class="glass"><div class="taskbar-time"></div><div class="taskbar-date"></div></div>

  <script src="database.js"></script>
  <script src="auth.js"></script>
  <script>
    let allUsers = [];
    let pendingImg64 = null;
    let mentionQuery = '';
    let mentionStart = -1;

requireAuth(async userData => {
	      document.getElementById('user-header').innerHTML = `
	        <div style="text-align: right;">
	          <span style="display: block; font-size: 13px; font-weight: 800;">${userData.nome}</span>
	          <small style="color: var(--text-light);">${userData.role} ¬∑ ${userData.xp || 0} XP</small>
	        </div>
	        <a href="perfil.html">${renderAvatar(userData, 'sm')}</a>
	      `;
	      if (userData.role === 'MASTER' || userData.role === 'admin') {
	        document.getElementById('master-gear').classList.remove('hidden');
	      }
	      document.getElementById('composer-avatar').innerHTML = renderAvatar(userData, 'md');

      // Load all users for mentions
      const snap = await db.collection('usuarios').where('aprovado','==',true).get();
      snap.forEach(d => allUsers.push({ uid: d.id, ...d.data() }));

      loadFeed(userData);
    });

    // ‚îÄ‚îÄ Text input + mention detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleTextInput(el) {
      const val = el.value;
      document.getElementById('char-count').textContent = `${val.length} / 1000`;

      // Detect @mention
      const cursor = el.selectionStart;
      const textBefore = val.slice(0, cursor);
      const atIdx = textBefore.lastIndexOf('@');
      const spaceAfterAt = textBefore.slice(atIdx+1).includes(' ');

      if (atIdx !== -1 && !spaceAfterAt && cursor - atIdx <= 20) {
        mentionStart = atIdx;
        mentionQuery = textBefore.slice(atIdx+1).toLowerCase();
        showMentionDropdown(mentionQuery, el);
      } else {
        hideMentionDropdown();
      }
    }

    function showMentionDropdown(q, textarea) {
      const dd = document.getElementById('mention-dd');
      const matches = allUsers.filter(u => u.nome.toLowerCase().includes(q)).slice(0,5);
      if (!matches.length) { hideMentionDropdown(); return; }
      dd.innerHTML = matches.map(u => `
        <div class="mention-item" onclick="insertMention('${u.nome}', '${u.uid}')">
          ${renderAvatar(u,'sm')}
          <span>${u.nome}</span>
          <span class="badge badge-blue" style="margin-left:auto;">${u.tipo==='interno'?'Interno':'Aut√¥nomo'}</span>
        </div>`).join('');
      dd.classList.remove('hidden');
    }

    function hideMentionDropdown() {
      document.getElementById('mention-dd').classList.add('hidden');
    }

    function insertMention(nome, uid) {
      const ta  = document.getElementById('post-text');
      const val = ta.value;
      const before = val.slice(0, mentionStart);
      const after  = val.slice(ta.selectionStart);
      ta.value = `${before}@${nome} ${after}`;
      hideMentionDropdown();
      ta.focus();
    }

    // ‚îÄ‚îÄ Image select ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleImgSelect(input) {
      const file = input.files[0]; if (!file) return;
      if (file.size > 900 * 1024) { showToast('Imagem muito grande! M√°x 900KB.','error'); return; }
      const reader = new FileReader();
      reader.onload = e => {
        pendingImg64 = e.target.result;
        document.getElementById('img-preview-wrap').innerHTML = `
          <div class="img-preview" style="margin-top:10px;">
            <img src="${pendingImg64}">
            <button class="img-preview-remove" onclick="removeImg()">‚úï</button>
          </div>`;
      };
      reader.readAsDataURL(file);
    }
    function removeImg() { pendingImg64 = null; document.getElementById('img-preview-wrap').innerHTML=''; document.getElementById('img-input').value=''; }

    // ‚îÄ‚îÄ Publish ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function publishPost() {
      const text = document.getElementById('post-text').value.trim();
      if (!text && !pendingImg64) { showToast('Escreva algo ou adicione uma foto.','error'); return; }
      if (text.length > 1000) { showToast('Texto muito longo (m√°x 1000 chars).','error'); return; }

      const hashtags = [...new Set((text.match(/#\w+/g) || []).map(h => h.toLowerCase()))];
      const mentionedUids = [];
      const mentionRegex = /@([\w√Ä-√ø ]+?)(?= |$|@|#)/g;
      let m;
      while ((m = mentionRegex.exec(text)) !== null) {
        const found = allUsers.find(u => u.nome.toLowerCase() === m[1].trim().toLowerCase());
        if (found) mentionedUids.push(found.uid);
      }

      const post = {
        autorUid: currentUser.uid,
        autorNome: currentUserData.nome,
        autorTipo: currentUserData.tipo,
        texto: text || null,
        fotoBase64: pendingImg64 || null,
        hashtags,
        mencoes: mentionedUids,
        curtidas: {},
        reacoes: {},
        criadoEm: firebase.firestore.FieldValue.serverTimestamp()
      };

await db.collection('posts').add(post);
	      await addXP(currentUser.uid, 20, 'Nova postagem no feed');
	      document.getElementById('post-text').value = '';
	      removeImg();
	      document.getElementById('char-count').textContent = '0 / 1000';
	      showToast('Post publicado! +20 XP üéâ','success');

      // Check desafios
      await checkDesafiosHashtag(hashtags);
    }

    // ‚îÄ‚îÄ Desafio hashtag checker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function checkDesafiosHashtag(hashtags) {
      const snap = await db.collection('desafios').where('ativo','==',true).where('tipo','==','hashtag').get();
      snap.forEach(async doc => {
        const d = { id: doc.id, ...doc.data() };
        if (d.completadoPor?.[currentUser.uid]) return; // already done
        const required = (d.hashtags || []).map(h => h.toLowerCase());
        const hasAll = required.every(h => hashtags.includes(h));
        if (hasAll) {
          await db.collection('desafios').doc(d.id).update({
            [`completadoPor.${currentUser.uid}`]: firebase.firestore.FieldValue.serverTimestamp()
          });
          await addXP(currentUser.uid, d.xpRecompensa, `Desafio: ${d.titulo}`);
          showToast(`üéâ Desafio conclu√≠do! +${d.xpRecompensa} XP ‚Äî ${d.titulo}`, 'success', 5000);
        }
      });
    }

    // ‚îÄ‚îÄ Load feed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadFeed(userData) {
      db.collection('posts').orderBy('criadoEm','desc').limit(30)
        .onSnapshot(snap => {
          const container = document.getElementById('posts-container');
          container.innerHTML = '';
          if (snap.empty) {
            container.innerHTML = '<div class="glass" style="padding:32px;text-align:center;"><p style="font-size:15px;color:var(--text-light);">Nenhum post ainda. Seja o primeiro! üöÄ</p></div>';
            return;
          }
          snap.forEach(doc => {
            const p = { id: doc.id, ...doc.data() };
            container.appendChild(buildPostCard(p, userData));
          });
        });
    }

    function buildPostCard(p, userData) {
      const card = document.createElement('div');
      card.className = 'glass post-card';
      card.id = `post-${p.id}`;

      const author = allUsers.find(u => u.uid === p.autorUid) || { nome: p.autorNome, tipo: p.autorTipo };
      const time   = p.criadoEm?.toDate ? p.criadoEm.toDate().toLocaleString('pt-BR') : 'Agora';
      const myReaction = p.reacoes?.[userData.uid] || null;
      const myLike   = p.curtidas?.[userData.uid] || false;
      const likeCount = Object.keys(p.curtidas||{}).length;

      // Format text
      let formattedText = (p.texto||'')
        .replace(/#(\w+)/g, '<span class="hashtag">#$1</span>')
        .replace(/@([\w√Ä-√ø ]+?)(?= |$|@|#)/g, (match, nome) => {
          const found = allUsers.find(u => u.nome.toLowerCase() === nome.trim().toLowerCase());
          return found ? `<a class="mention" href="perfil.html?uid=${found.uid}">@${nome.trim()}</a>` : match;
        });

      // Reaction counts
      const reactionCounts = {};
      Object.values(p.reacoes||{}).forEach(r => { reactionCounts[r] = (reactionCounts[r]||0)+1; });
      const reactionsHTML = Object.entries(reactionCounts).map(([e,c]) => `<span class="reaction-btn">${e} ${c}</span>`).join('');

      card.innerHTML = `
        <div class="post-header">
          ${renderAvatar(author,'sm')}
          <div style="flex:1;">
            <a href="perfil.html?uid=${p.autorUid}" style="font-size:14px;font-weight:800;color:var(--text);text-decoration:none;">${p.autorNome}</a>
            <p style="font-size:11px;color:var(--text-light);">${time}</p>
          </div>
          ${p.autorUid === userData.uid || userData.role === 'admin' ? `<button class="btn btn-red btn-sm" onclick="deletePost('${p.id}')">üóë</button>` : ''}
        </div>
        ${p.texto ? `<div class="post-body"><p class="post-text">${formattedText}</p></div>` : ''}
        ${p.fotoBase64 ? `<img class="post-img" src="${p.fotoBase64}" loading="lazy">` : ''}
        <div class="post-footer">
          <div class="reaction-bar">
            <div style="position:relative;">
              <button class="reaction-btn ${myLike?'active':''}" onclick="toggleLike('${p.id}')">
                ‚ù§Ô∏è ${likeCount || ''}
              </button>
            </div>
            <div style="position:relative;" id="react-wrap-${p.id}">
              <button class="reaction-btn" onclick="toggleReactPicker('${p.id}')">
                ${myReaction||'üòä'} Reagir
              </button>
              <div class="reaction-picker hidden" id="react-picker-${p.id}">
                ${['üòÇ','üëè','üî•','üòç','üò¢','ü§Ø'].map(e=>`<span class="reaction-emoji" onclick="setReaction('${p.id}','${e}')">${e}</span>`).join('')}
              </div>
            </div>
            ${reactionsHTML}
          </div>
          <button class="btn btn-blue btn-sm" onclick="toggleComments('${p.id}')">üí¨ Comentar</button>
          <button class="reaction-btn" onclick="repost('${p.id}','${p.autorNome}')">üîÅ</button>
        </div>
        <div class="comments-section hidden" id="comments-${p.id}"></div>
        <div class="comment-input-row hidden" id="comment-input-${p.id}">
          <div style="flex:1;" class="input-wrap">
            <input type="text" class="aero-input" style="padding-left:14px;" placeholder="Escreva um coment√°rio..." id="comment-text-${p.id}">
          </div>
          <button class="btn btn-blue btn-sm" onclick="sendComment('${p.id}')">‚Üí</button>
        </div>`;

      return card;
    }

    async function toggleLike(postId) {
      const ref = db.collection('posts').doc(postId);
      const doc = await ref.get();
      const curtidas = doc.data().curtidas || {};
      if (curtidas[currentUser.uid]) {
        delete curtidas[currentUser.uid];
      } else {
        curtidas[currentUser.uid] = true;
      }
      await ref.update({ curtidas });
    }

    function toggleReactPicker(postId) {
      const picker = document.getElementById(`react-picker-${postId}`);
      picker.classList.toggle('hidden');
    }

    async function setReaction(postId, emoji) {
      await db.collection('posts').doc(postId).update({ [`reacoes.${currentUser.uid}`]: emoji });
      document.getElementById(`react-picker-${postId}`).classList.add('hidden');
    }

    async function repost(postId, autorNome) {
      const text = `üîÅ Repostou de @${autorNome}`;
      await db.collection('posts').add({
        autorUid: currentUser.uid, autorNome: currentUserData.nome,
        autorTipo: currentUserData.tipo,
        texto: text, fotoBase64: null, hashtags: [],
        mencoes: [], curtidas: {}, reacoes: {},
        repostDe: postId,
        criadoEm: firebase.firestore.FieldValue.serverTimestamp()
      });
      showToast('Post compartilhado! üîÅ','success');
    }

    async function deletePost(postId) {
      const ok = await showConfirm('Deletar este post?');
      if (!ok) return;
      await db.collection('posts').doc(postId).delete();
      showToast('Post removido.','info');
    }

    function toggleComments(postId) {
      const el  = document.getElementById(`comments-${postId}`);
      const inp = document.getElementById(`comment-input-${postId}`);
      const open = el.classList.toggle('hidden');
      inp.classList.toggle('hidden', open);
      if (!open) loadComments(postId);
    }

    function loadComments(postId) {
      const el = document.getElementById(`comments-${postId}`);
      el.innerHTML = '';
      db.collection('posts').doc(postId).collection('comentarios')
        .orderBy('criadoEm','asc').limit(30)
        .onSnapshot(snap => {
          el.innerHTML = '';
          snap.forEach(doc => {
            const c = doc.data();
            el.innerHTML += `
              <div class="comment-item">
                ${renderAvatar(allUsers.find(u=>u.uid===c.autorUid)||{nome:c.autorNome},'sm')}
                <div class="comment-bubble">
                  <strong>${c.autorNome}</strong>
                  <p>${c.texto}</p>
                </div>
              </div>`;
          });
        });
    }

    async function sendComment(postId) {
      const inp  = document.getElementById(`comment-text-${postId}`);
      const text = inp.value.trim();
      if (!text) return;
      await db.collection('posts').doc(postId).collection('comentarios').add({
        autorUid: currentUser.uid, autorNome: currentUserData.nome,
        texto: text, criadoEm: firebase.firestore.FieldValue.serverTimestamp()
      });
      inp.value = '';
    }

    // Close reaction pickers on outside click
    document.addEventListener('click', e => {
      if (!e.target.closest('[id^="react-wrap-"]')) {
        document.querySelectorAll('[id^="react-picker-"]').forEach(el => el.classList.add('hidden'));
      }
    });
  </script>
</body>
</html>
